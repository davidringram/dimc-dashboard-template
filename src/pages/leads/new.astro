---
import Layout from "../../layouts/Layout.astro";
import { createSupabase } from "../../lib/supabase";

const supabase = createSupabase(Astro);

const {
    data: { user },
} = await supabase.auth.getUser();
if (!user) {
    return Astro.redirect("/login");
}

let errorMessage = "";

if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();

        // Collect all fields to match the Dossier schema
        const updates = {
            name: formData.get("name")?.toString(),
            email: formData.get("email")?.toString(),
            phone: formData.get("phone")?.toString(),
            geo_location: formData.get("geo_location")?.toString(), // NEW
            service: formData.get("service")?.toString(), // NEW
            notes: formData.get("notes")?.toString(), // NEW
            status: formData.get("status")?.toString(),
            estimated_value: parseFloat(
                formData.get("estimated_value")?.toString() || "0",
            ),
            utm_source: formData.get("utm_source")?.toString(),
            utm_medium: formData.get("utm_medium")?.toString(),
            utm_campaign: formData.get("utm_campaign")?.toString(),
        };

        const { data, error } = await supabase
            .from("leads")
            .insert(updates)
            .select()
            .single();

        if (error) {
            errorMessage = `Database Error: ${error.message}`;
        } else {
            // Redirect straight to the new dossier
            return Astro.redirect(`/leads/${data.id}?saved=true`);
        }
    } catch (error) {
        errorMessage = "System Malfunction: Operation failed.";
    }
}
---

<Layout title="Initiate New Op">
    <div class="min-h-screen bg-[#353c33] text-white font-sans p-6 md:p-10">
        <div class="max-w-4xl mx-auto">
            <div
                class="flex justify-between items-end mb-8 border-b border-[#576352] pb-4"
            >
                <div>
                    <h1
                        class="text-3xl font-black uppercase tracking-tight text-white"
                    >
                        Initiate New Op
                    </h1>
                    <p class="text-[#9ca3af] mt-1 text-xs font-mono uppercase">
                        Enter subject intelligence below
                    </p>
                </div>
                <a
                    href="/dashboard"
                    class="text-gray-400 hover:text-[#ea580c] text-xs font-bold uppercase tracking-widest transition-colors mb-2"
                >
                    ‚Üê Abort & Return
                </a>
            </div>

            {
                errorMessage && (
                    <div class="p-4 mb-6 bg-red-900/20 border border-red-900 text-red-400 text-xs font-bold uppercase tracking-wide">
                        {errorMessage}
                    </div>
                )
            }

            <form
                method="POST"
                class="bg-[#282e26] border border-[#1f241d] p-8 rounded-sm shadow-2xl"
            >
                <div class="mb-8">
                    <h3
                        class="text-xs font-bold text-[#ea580c] uppercase tracking-widest mb-4 border-b border-[#353c33] pb-2"
                    >
                        Subject Intelligence
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="col-span-1 md:col-span-2">
                            <label for="name" class="label"
                                >Client / Subject Name *</label
                            >
                            <input
                                type="text"
                                id="name"
                                name="name"
                                class="input-field"
                                placeholder="e.g. John Doe or Stark Industries"
                                required
                            />
                        </div>

                        <div>
                            <label for="email" class="label">Email Comm *</label
                            >
                            <input
                                type="email"
                                id="email"
                                name="email"
                                class="input-field"
                                placeholder="contact@target.com"
                                required
                            />
                        </div>

                        <div>
                            <label for="phone" class="label">Phone Comm</label>
                            <input
                                type="tel"
                                id="phone"
                                name="phone"
                                class="input-field"
                                placeholder="+1 (555) 000-0000"
                            />
                        </div>

                        <div>
                            <label for="geo_location" class="label"
                                >Geo Location (City/State)</label
                            >
                            <input
                                type="text"
                                id="geo_location"
                                name="geo_location"
                                class="input-field"
                                placeholder="e.g. Riverside, CA"
                            />
                        </div>

                        <div>
                            <label for="service" class="label"
                                >Target Objective (Service)</label
                            >
                            <input
                                type="text"
                                id="service"
                                name="service"
                                class="input-field"
                                placeholder="e.g. Divorce, Deck Build"
                            />
                        </div>
                    </div>
                </div>

                <div class="mb-8">
                    <h3
                        class="text-xs font-bold text-[#958a73] uppercase tracking-widest mb-4 border-b border-[#353c33] pb-2"
                    >
                        Mission Parameters
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="status" class="label"
                                >Initial Phase</label
                            >
                            <select
                                id="status"
                                name="status"
                                class="input-field appearance-none"
                            >
                                <option value="New">New</option>
                                <option value="Contacted">Contacted</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Won">Won</option>
                                <option value="Lost">Lost</option>
                            </select>
                        </div>

                        <div>
                            <label for="estimated_value" class="label"
                                >Projected Value ($)</label
                            >
                            <div class="relative">
                                <span
                                    class="absolute left-3 top-2.5 text-gray-500 text-sm"
                                    >$</span
                                >
                                <input
                                    type="number"
                                    id="estimated_value"
                                    name="estimated_value"
                                    class="input-field pl-6 font-mono"
                                    placeholder="0.00"
                                />
                            </div>
                        </div>

                        <div class="col-span-1 md:col-span-2">
                            <label for="notes" class="label"
                                >Initial Recon Notes</label
                            >
                            <textarea
                                id="notes"
                                name="notes"
                                rows="3"
                                class="input-field"
                                placeholder="Enter any preliminary details..."
                            ></textarea>
                        </div>
                    </div>
                </div>

                <div class="mb-8">
                    <h3
                        class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 border-b border-[#353c33] pb-2"
                    >
                        Source Attribution (UTM)
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="utm_source" class="label">Source</label>
                            <input
                                type="text"
                                id="utm_source"
                                name="utm_source"
                                class="input-field"
                                placeholder="e.g. Google"
                            />
                        </div>
                        <div>
                            <label for="utm_medium" class="label">Medium</label>
                            <input
                                type="text"
                                id="utm_medium"
                                name="utm_medium"
                                class="input-field"
                                placeholder="e.g. CPC"
                            />
                        </div>
                        <div>
                            <label for="utm_campaign" class="label"
                                >Campaign</label
                            >
                            <input
                                type="text"
                                id="utm_campaign"
                                name="utm_campaign"
                                class="input-field"
                                placeholder="e.g. Spring_26"
                            />
                        </div>
                    </div>
                </div>

                <div
                    class="flex items-center gap-4 pt-4 border-t border-[#353c33]"
                >
                    <button
                        type="submit"
                        class="bg-[#ea580c] hover:bg-[#c2410c] text-white font-bold py-3 px-8 rounded-sm uppercase tracking-wider text-xs shadow-lg transition-transform transform active:scale-95"
                    >
                        Create Dossier
                    </button>
                    <a
                        href="/dashboard"
                        class="text-gray-500 hover:text-white font-bold text-xs uppercase tracking-wider px-4"
                    >
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</Layout>

<style>
    .label {
        @apply block text-[10px] uppercase font-bold text-gray-500 mb-1 tracking-wider;
    }

    .input-field {
        @apply w-full bg-[#1f241d] border border-[#353c33] text-white text-sm p-3 rounded-sm focus:border-[#ea580c] focus:ring-1 focus:ring-[#ea580c] outline-none transition-colors placeholder-gray-700;
    }
</style>
