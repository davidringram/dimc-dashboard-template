---
import Layout from "../layouts/Layout.astro";
import { createSupabase } from "../lib/supabase";

const supabase = createSupabase(Astro);
const { cookies, redirect } = Astro;

// 1. AUTO-REDIRECT IF ALREADY LOGGED IN
const {
    data: { session },
} = await supabase.auth.getSession();
if (session) {
    return redirect("/dashboard");
}

// 2. HANDLE LOGIN
let errorMsg = "";

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const email = formData.get("email")?.toString();
    const password = formData.get("password")?.toString();

    if (!email || !password) {
        errorMsg = "Identify yourself.";
    } else {
        const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password,
        });

        if (error) {
            errorMsg = "Access Denied: Invalid credentials.";
        } else {
            const { access_token, refresh_token } = data.session;
            cookies.set("sb-access-token", access_token, { path: "/" });
            cookies.set("sb-refresh-token", refresh_token, { path: "/" });
            return redirect("/dashboard");
        }
    }
}
---

<Layout title="Login // DIM&C">
    <div
        class="min-h-screen flex items-center justify-center bg-[#1f241d] text-white font-sans p-4"
    >
        <div
            class="w-full max-w-md bg-[#282e26] border border-[#353c33] p-8 rounded-sm shadow-2xl relative"
        >
            <div class="absolute top-0 left-0 w-full h-1 bg-[#ea580c]"></div>

            <div class="text-center mb-8">
                <h1 class="text-3xl font-black uppercase tracking-tight mb-1">
                    DIM&C <span class="text-[#ea580c]">OS</span>
                </h1>
                <p class="text-xs text-gray-500 uppercase tracking-widest">
                    Authorized Personnel Only
                </p>
            </div>

            {
                errorMsg && (
                    <div class="mb-6 p-3 bg-red-900/20 border border-red-900 text-red-400 text-xs font-bold uppercase tracking-wide text-center">
                        {errorMsg}
                    </div>
                )
            }

            <form method="POST" class="space-y-5">
                <div>
                    <label
                        for="email"
                        class="block text-[10px] uppercase font-bold text-gray-500 mb-1"
                        >Operative ID (Email)</label
                    >
                    <input
                        type="email"
                        name="email"
                        id="email"
                        required
                        class="w-full bg-[#1a1e18] border border-[#353c33] text-white p-3 rounded-sm focus:border-[#ea580c] focus:ring-1 focus:ring-[#ea580c] outline-none transition-colors placeholder-gray-700"
                        placeholder="operative@dimc.com"
                    />
                </div>
                <div>
                    <label
                        for="password"
                        class="block text-[10px] uppercase font-bold text-gray-500 mb-1"
                        >Security Clearance</label
                    >
                    <input
                        type="password"
                        name="password"
                        id="password"
                        required
                        class="w-full bg-[#1a1e18] border border-[#353c33] text-white p-3 rounded-sm focus:border-[#ea580c] focus:ring-1 focus:ring-[#ea580c] outline-none transition-colors placeholder-gray-700"
                        placeholder="••••••••"
                    />
                </div>

                <button
                    type="submit"
                    class="w-full bg-[#ea580c] hover:bg-[#c2410c] text-white font-bold py-3 rounded-sm uppercase tracking-wider text-sm transition-all shadow-lg mt-2"
                >
                    Authenticate
                </button>
            </form>

            <div class="mt-8 text-center border-t border-[#353c33] pt-4">
                <p class="text-[10px] text-gray-600 font-mono">
                    SYSTEM SECURE // ENCRYPTION: ACTIVE
                </p>
            </div>
        </div>
    </div>
</Layout>
