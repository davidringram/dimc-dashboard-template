---
const { lead, border = "border-gray-200" } = Astro.props;

// Calculate "Lead Rot" (Is it older than 24 hours and still New?)
const hoursSinceCreation =
    (new Date().getTime() - new Date(lead.created_at).getTime()) /
    (1000 * 60 * 60);
const isRotting = lead.status === "New" && hoursSinceCreation > 24;
---

<div
    class={`relative group p-4 bg-white border ${isRotting ? "border-red-400 bg-red-50 dark:bg-red-900/10" : border} rounded-lg shadow-sm hover:shadow-md dark:bg-gray-700 dark:border-gray-600 transition-shadow`}
>
    {
        isRotting && (
            <span class="absolute -top-2 -left-2 bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm z-10 animate-pulse">
                LATE
            </span>
        )
    }

    <div class="flex justify-between items-start mb-2">
        <h4
            class="font-semibold text-gray-900 dark:text-white truncate pr-6 text-base"
        >
            <a
                href={`/leads/${lead.id}`}
                class="hover:text-blue-600 hover:underline"
            >
                {lead.name}
            </a>
        </h4>

        <form
            action="/actions/archive_lead"
            method="POST"
            class="opacity-0 group-hover:opacity-100 transition-opacity absolute top-2 right-2"
        >
            <input type="hidden" name="lead_id" value={lead.id} />
            <button
                type="submit"
                title="Archive Lead"
                class="text-gray-400 hover:text-red-500 dark:text-gray-500 dark:hover:text-red-400"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="w-4 h-4"
                    ><path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5m8.25 3v6.75m0 0-3-3m3 3 3-3M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z"
                    ></path></svg
                >
            </button>
        </form>
    </div>

    <p class="text-lg text-green-600 dark:text-green-400 font-bold mb-3">
        ${(lead.estimated_value || 0).toLocaleString()}
    </p>

    <div class="space-y-1.5 mb-3">
        {
            lead.email && (
                <div class="flex items-center text-sm text-gray-600 dark:text-gray-300">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="w-3.5 h-3.5 mr-2 shrink-0 opacity-70"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75"
                        />
                    </svg>
                    <a
                        href={`mailto:${lead.email}`}
                        class="truncate hover:text-blue-600 hover:underline"
                    >
                        {lead.email}
                    </a>
                </div>
            )
        }
        {
            lead.phone && (
                <div class="flex items-center text-sm text-gray-600 dark:text-gray-300">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="w-3.5 h-3.5 mr-2 shrink-0 opacity-70"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 4.5v2.25Z"
                        />
                    </svg>
                    <a
                        href={`tel:${lead.phone}`}
                        class="truncate hover:text-blue-600 hover:underline"
                    >
                        {lead.phone}
                    </a>
                </div>
            )
        }
    </div>

    <div
        class="pt-3 border-t border-gray-100 dark:border-gray-600 flex justify-between items-center"
    >
        <span
            class="text-xs font-medium bg-gray-100 dark:bg-gray-800 px-1.5 py-0.5 rounded text-gray-600 dark:text-gray-400"
        >
            {lead.utm_source || "Direct"}
        </span>

        <form action="/actions/update_status" method="POST">
            <input type="hidden" name="lead_id" value={lead.id} />
            <input
                type="hidden"
                name="current_url"
                value={Astro.url.pathname + Astro.url.search}
            />

            <select
                name="status"
                onchange="this.form.submit()"
                class="text-xs border-none bg-transparent text-gray-500 focus:ring-0 cursor-pointer hover:text-blue-600 font-bold text-right pr-0"
            >
                <option value="New" selected={lead.status === "New"}>New</option
                >
                <option value="Contacted" selected={lead.status === "Contacted"}
                    >Contacted</option
                >
                <option
                    value="In Progress"
                    selected={lead.status === "In Progress"}>In Progress</option
                >
                <option value="Won" selected={lead.status === "Won"}>Won</option
                >
                <option value="Lost" selected={lead.status === "Lost"}
                    >Lost</option
                >
            </select>
        </form>
    </div>
</div>
